#
# This file defines a `make_doc` bash function.
# 
# It expects environment variables:
#
# - `version_string`
# - `findlib_packages` (space separated)
# - `authors` (bash-array of [print-name email webpage])
# - optionally `KAPI_DOC`: if `no` then do not build the OCamlDoc part

make_doc () {
  local git_branch=`git symbolic-ref --short HEAD`
  local outdir=_doc/
  if [ "$git_branch" != "master" ]; then
    outdir=_doc/$git_branch
  fi
  local apidoc=_apidoc/$git_branch
  if [ "$KAPI_DOC" != "no" ] ; then
    local ocamlfind_package_options=`for p in $findlib_packages ; do echo -n "-package $p " ; done`
    mkdir -p $apidoc
    ocamlfind ocamldoc -html -d $apidoc $ocamlfind_package_options  -thread \
      -charset UTF-8 -t "Ketrew API" -keep-code -colorize-code -sort \
      -I _obuild/ketrew/ $lib_mli_files $lib_ml_files 
  fi

  INPUT=src/doc/,src/test/ \
    INDEX=README.md \
    TITLE_PREFIX="Ketrew: " \
    API=$apidoc/ \
    COMMAND_SUBSTITUTIONS=ketrew:_obuild/ketrew-app/ketrew-app.asm \
    OUTPUT_DIR=$outdir \
    TITLE_SUBSTITUTIONS="dummy_plugin:Plugin Example, \
                         dummy_plugin_user:Plugin-Usage Example, \
                         integration:Integration Test, \
                         preconfigured_main.ml:Preconfigured Main Example, \
                         main:Main Test" \
    oredoc

}

